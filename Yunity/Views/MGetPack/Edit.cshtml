@model Yunity.Models.GetPackWrap

@{
    Layout = "_LayoutManager";
    ViewData["Title"] = "Edit";
}
@section Styles{
    <style>
        table{
            width:100%;
            border-collapse:collapse;
            background: transparent;
        }
        th,td{
            border-bottom: 1px solid #ddd;
            padding: 5px;
            text-align: left;
        }
        th{
            font-size: 20px;
        }
        td{
            font-size: 18px;
        }

        .form-control {
            font-size: 1.1rem;
            box-shadow: 5px 5px 10px rgba(150, 150, 150, 0.3), -5px -5px 15px rgba(240, 240, 240, 0.4);
            border: 1px solid;
            background: rgb(255 255 255);
            color: #3a525e;
        }

    </style>
}


<div class="container my-3">

<nav style="--bs-breadcrumb-divider:'>';margin-left:300px;" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-action="Index" asp-area="Concierge" style="color:#9BA8Ab;">首頁</a></li>
        <li class="breadcrumb-item "><a asp-action="Index" asp-area="MBoard" style="color:#9BA8Ab;">包裹列表</a></li>
        <li class="breadcrumb-item "><a asp-action="Detail" asp-route-id="@Model.Id" asp-area="MBoard" style="color:#9BA8Ab;">包裹詳細資訊</a></li>
        <li class="breadcrumb-item " aria-current="page" style="color:#31515e">編輯</li>
    </ol>
</nav>

<h3 class="text-center">編輯包裹資訊</h3>
<div class="container">
    <form asp-action="Edit" method="post" enctype="multipart/form-data">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

        <div class="row">
            <div class="col-md-7 mt-3">
                <input type="hidden" asp-for="Id" class="form-control" />
                <table class="table">
                    <tr>
                        <th>包裹編號</th>
                        <td>
                            <input asp-for="PackNo" class="form-control rounded-pill" />
                            <span asp-validation-for="PackNo" class="text-danger"></span>
                        </td>
                    </tr>
                    <tr>
                        <th>包裹類型</th>
                        <td>
                            <select asp-for="Type" id="Type" class="form-control rounded-pill">
                                <option value="1">信件</option>
                                <option value="2">一般包裹</option>
                                <option value="3">冷藏包裹</option>
                            </select>
                            <span asp-validation-for="Type" class="text-danger"></span>
                        </td>
                    </tr>
                    <tr>
                        <th>收件人</th>
                        <td>
                            <input asp-for="GetUser" class="form-control rounded-pill" />
                            <span asp-validation-for="GetUser" class="text-danger"></span>
                        </td>
                    </tr>
                    <tr>
                        <th>門牌號</th>
                        <td>
                            <input asp-for="DoorNo" class="form-control rounded-pill" />
                            <span asp-validation-for="DoorNo" class="text-danger"></span>
                        </td>
                    </tr>
                    <tr>
                        <th>物流公司</th>
                        <td>
                            <input asp-for="Logistic" class="form-control rounded-pill" />
                            <span asp-validation-for="Logistic" class="text-danger"></span>
                        </td>
                    </tr>
                    <tr>
                        <th>登陸時間</th>
                        <td>
                            <input asp-for="LogTime" class="form-control rounded-pill" readonly />
                        </td>
                    </tr>
                    <tr>
                        <th>領取人</th>
                        <td>
                            <input asp-for="PickUser" id="PickUser" class="form-control rounded-pill" />
                            <span asp-validation-for="PickUser" class="text-danger"></span>
                        </td>
                    </tr>
                    <tr>
                        <th>領取時間</th>
                        <td>
                            <input asp-for="PickTime" class="form-control rounded-pill" readonly />
                        </td>
                    </tr>
                    <tr>
                        <th>狀態</th>
                        <td class="d-flex align-items-center justify-content-between mt-2">
                            <span id="txtpackstate"
                                  style="color: @(Model.State == 0 ? "darkred" : "#01814A"); font-size: 20px"
                                  class="fw-bold">
                                @((Model.State == 0) ? "未領取" : "已領取")
                            </span>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="ChkState" style="height:30px;width:60px;"
                                @(Model.State == 0 ? "" : "checked") onchange="updateState()" />
                                <input type="hidden" id="packState" name="State" value="@(Model.State)" />
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="col-md-4 mt-3">
                <h5 class="mb-2">照片</h5>
                <input type="file" asp-for="ImageFile" class="form-control mb-2" onchange="previewImage(event)" accept="image/*" />
                @if (!string.IsNullOrEmpty(Model.GetPack.PackPhoto))
                {
                    <img id="imagePreview" src="@Url.Content("~/GetPackPhoto/" + Model.GetPack.PackPhoto)" alt="Image Preview" class="img-fluid" />
                }
                else
                {
                    <img id="imagePreview" src="@Url.Content("~/images/noPic.jpeg")" alt="Image Preview" class="img-fluid" />
                }
            </div>
        </div>

        <div class="mt-5 text-center">
            <input type="submit" value="確認修改" class="btn btn-primary-Manager" style="width:150px;border-radius:100px;" />
        </div>
    </form>
</div>
</div>

<div>
    <a asp-action="Detail" asp-route-id="@Model.Id" style="position: fixed; bottom: 75px; right: 20px; color: #d1e3e1;font-size:3rem; z-index: 9999;">
        <i class="bi bi-arrow-left-circle-fill"></i>
    </a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function updateState() {
            let chkState = document.getElementById("ChkState");
            let packState = document.getElementById("packState");
            let txtPackState = document.getElementById("txtpackstate");
            let pickUser = document.getElementById("PickUser");
            let pickTime = document.getElementById("PickTime");

            if (!pickUser.value.trim() && chkState.checked) {
                Swal.fire({
                    icon: "warning",
                    title: "提醒",
                    text: "請先填寫領取人名稱！",
                    confirmButtonText: "確定"
                }).then(() => {
                    chkState.checked = packState.value === "1";
                });
                return;
            }

            let action = chkState.checked ? "已領取" : "未領取";
            let msg = `確定將包裹標記為『${action}』？`;

            Swal.fire({
                title: "狀態變更",
                text: msg,
                icon: "question",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "確定",
                cancelButtonText: "取消"
            }).then((result) => {
                if (result.isConfirmed) {
                    packState.value = chkState.checked ? "1" : "0";

                    txtPackState.textContent = chkState.checked ? "已領取" : "未領取";
                    txtPackState.style.color = chkState.checked ? "#01814A" : "darkred";

                    if (chkState.checked) {
                        pickTime.value = getCurrentDateTime(); 
                    } else {
                        pickUser.value = ""; 
                        pickTime.value = ""; 
                    }
                } else {
                    chkState.checked = packState.value === "1";
                }
            });
        }

        function getCurrentDateTime() {
            return new Date().toISOString().slice(0, 19).replace("T", " ");
        }

        function previewImage(event) {
            var file = event.target.files[0];

            if (file) {
                if (!file.type.startsWith("image/")) {
                    Swal.fire({
                        icon: "error",
                        title: "格式錯誤",
                        text: "請上傳圖片文件！",
                        confirmButtonText: "確定"
                    });
                    return;
                }

                var reader = new FileReader();
                reader.onload = function (e) {
                    var imagePreview = document.getElementById('imagePreview');
                    if (imagePreview) {
                        imagePreview.src = e.target.result;
                    }
                };
                reader.readAsDataURL(file);
            }
        }
    </script>

}
